<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>माँ कृपा गणपति समिति 2025</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-app.min.js" onerror="tryBackupCDN()"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-firestore.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/8.10.1/firebase-storage.min.js"></script>
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <!-- Firebase SDKs -->
  <style>
    * {box-sizing: border-box; margin: 0; padding: 0;}
    body {font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #fff7ed 0%, #fef2f2 100%); min-height: 100vh;}
    .header {background: linear-gradient(135deg, #ea580c 0%, #dc2626 100%); color: white; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;}
    .header h1 {font-size: 2rem; margin-bottom: 0.5rem; font-weight: bold;}
    .header p {color: #fed7aa;}
    .nav-container {background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-bottom: 1px solid #e5e7eb;}
    .nav-buttons {max-width: 1200px; margin: 0 auto; padding: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;}
    .nav-btn {display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; text-decoration: none;}
    .nav-btn.active {background: #ea580c; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
    .nav-btn:not(.active) {background: #f3f4f6; color: #374151;}
    .nav-btn:not(.active):hover {background: #fed7aa; color: #ea580c;}
    .page-container {max-width: 1200px; margin: 0 auto; padding: 2rem 1rem;}
    .page {display: none;}
    .page.active {display: block;}
    .card {background: white; border-radius: 1rem; padding: 2rem; box-shadow: 0 10px 15px rgba(0,0,0,0.1); margin-bottom: 2rem;}
    .card-header {display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;}
    .card-header h2 {font-size: 1.5rem; font-weight: bold; color: #1f2937;}
    .welcome-card {text-align: center; margin-bottom: 2rem;}
    .page-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap: 1.5rem; margin-top: 2rem;}
    .page-card {background: linear-gradient(135deg,var(--gradient-from),var(--gradient-to)); padding: 2rem; border-radius: 1rem; color: white; cursor: pointer; transform: scale(1); transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
    .page-card:hover {transform: scale(1.05);}
    .page-card i {font-size: 2rem; margin-bottom: 1rem;}
    .form-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 1.5rem;}
    .form-group {display: flex; flex-direction: column; gap: 1rem;}
    .form-input {padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; transition: all 0.3s ease;}
    .form-input:focus {outline: none; border-color: #ea580c;}
    .file-upload {border: 2px dashed #d1d5db; border-radius: 0.5rem; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s ease;}
    .file-upload:hover {border-color: #ea580c; background: #fef2f2;}
    .file-upload input {display: none;}
    .btn {display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer;}
    .btn-primary {background: linear-gradient(135deg,#10b981 0%,#059669 100%);color: white;}
    .btn-secondary {background: linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color: white;}
    .btn-accent {background: linear-gradient(135deg,#8b5cf6 0%, #7c3aed 100%);color: white;}
    .btn-danger {background: linear-gradient(135deg,#ef4444 0%, #dc2626 100%);color: white;}
    .btn:hover {box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
    .table-container {overflow-x: auto; margin: 1rem 0;}
    .data-table {width: 100%; border-collapse: collapse; background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
    .data-table th {background: #f3f4f6; padding: 1rem; text-align: left; font-weight: 600; color: #374151;}
    .data-table td {padding: 1rem; border-top: 1px solid #e5e7eb;}
    .data-table tr:hover {background: #f9fafb;}
    .badge {display: inline-block; padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; text-transform: uppercase;}
    .badge-success {background: #d1fae5; color: #065f46;}
    .badge-info {background: #dbeafe; color: #1e40af;}
    .total-display {background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 0.5rem; text-align: center; margin-top: 1.5rem;}
    .total-display h3 {font-size: 1.125rem; margin-bottom: 0.5rem;}
    .total-display .amount {font-size: 2rem; font-weight: bold;}
    .member-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap: 1.5rem; margin-top: 1.5rem;}
    .member-card {background: white; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 1.5rem; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.3s ease; position: relative;}
    .member-card:hover {box-shadow: 0 10px 15px rgba(0,0,0,0.1);}
    .member-photo {width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin: 0 auto 1rem; border: 4px solid #c084fc;}
    .member-placeholder {width: 80px; height: 80px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; font-size: 1.5rem; color: #6b7280;}
    .delete-btn {position: absolute; top: 0.5rem; right: 0.5rem; background: white; border: none; border-radius: 50%; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.3s ease;}
    .member-card:hover .delete-btn {opacity: 1;}
    .image-grid {display: grid; grid-template-columns: repeat(auto-fill, minmax(200px,1fr)); gap: 1rem; margin-top: 1.5rem;}
    .image-item {position: relative; aspect-ratio: 1; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
    .image-item img {width: 100%; height: 100%; object-fit: cover; cursor: pointer;}
    .image-item .delete-btn {top: 0.5rem; right: 0.5rem; background: rgba(239,68,68,0.9); color: white;}
    .modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; padding: 1rem;}
    .modal.active {display: flex;}
    .modal-content {position: relative; max-width: 90vw; max-height: 90vh;}
    .modal img {max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 0.5rem;}
    .modal-close {position: absolute; top: 1rem; right: 1rem; background: white; border: none; border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer;}
    .modal-info {position: absolute; bottom: 1rem; left: 1rem; background: rgba(255,255,255,0.9); padding: 0.5rem; border-radius: 0.5rem;}
    .empty-state {text-align: center; padding: 3rem; color: #6b7280;}
    .empty-state i {font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;}
    @media (max-width: 768px) {.header h1 {font-size: 1.5rem;}.nav-buttons {justify-content: center;}.form-grid {grid-template-columns: 1fr;}.page-grid {grid-template-columns: 1fr;}
                               .btn, .btn-primary, .btn-secondary, .btn-accent, .btn-danger {
    padding: 0.5rem 0.75rem;
    font-size: 0.95rem;
  }
  .btn i {
    font-size: 1rem;
  }}
    @media (max-width: 480px) {
  .btn, .btn-primary, .btn-secondary, .btn-accent, .btn-danger {
    padding: 0.5rem 0.75rem;
    font-size: 0.95rem;
  }
  .btn i {
    font-size: 1rem;
  }
}

  </style>
</head>
<body>
<!-- Header -->
<header class="header">
  <h1>माँ कृपा गणपति समिति 2025</h1>
  <i class="fas fa-om" style="font-size: 3rem; margin-bottom: 0.5rem;"></i>
  <p>Ganpati Bappa Morya!</p>
</header>
<!-- Navigation -->
<nav class="nav-container" id="navigation" style="display: none;">
  <div class="nav-buttons">
    <button class="nav-btn" data-page="home"><i class="fas fa-home"></i><span>Home</span></button>
    <button class="nav-btn" data-page="donations"><i class="fas fa-donate"></i><span>Donations</span></button>
    <button class="nav-btn" data-page="expenses"><i class="fas fa-receipt"></i><span>Expenses</span></button>
    <button class="nav-btn" data-page="members"><i class="fas fa-users"></i><span>Members</span></button>
    <button class="nav-btn" data-page="gallery"><i class="fas fa-images"></i><span>Gallery</span></button>
  </div>
</nav>
<!-- Page Container -->
<div class="page-container">
  <!-- Home Page -->
  <div id="home" class="page active">
    <div class="card welcome-card">
      <i class="fas fa-om" style="font-size: 4rem; color: #ea580c; margin-bottom: 1rem;"></i>
      <h2 style="font-size: 2rem; margin-bottom: 1rem; color: #1f2937;">Welcome to माँ कृपा गणपति समिति 2025</h2>
      <p style="font-size: 1.125rem; color: #6b7280; margin-bottom: 2rem;">Manage your Ganpati festival activities with ease</p>
      <div class="page-grid">
        <div class="page-card" style="--gradient-from: #10b981; --gradient-to: #059669;" data-page="donations">
          <i class="fas fa-donate"></i>
          <h3>Donations</h3><p>Track all donations received</p>
        </div>
        <div class="page-card" style="--gradient-from: #3b82f6; --gradient-to: #1d4ed8;" data-page="expenses">
          <i class="fas fa-receipt"></i>
          <h3>Expenses</h3><p>Manage festival expenses</p>
        </div>
        <div class="page-card" style="--gradient-from: #8b5cf6; --gradient-to: #7c3aed;" data-page="members">
          <i class="fas fa-users"></i>
          <h3>Members</h3><p>Member info</p>
        </div>
        <div class="page-card" style="--gradient-from: #ea580c; --gradient-to: #dc2626;" data-page="gallery">
          <i class="fas fa-images"></i>
          <h3>Gallery</h3><p>Festival photo gallery</p>
        </div>
       <div class="page-card" style="--gradient-from: #2563eb; --gradient-to: #3b82f6; text-align: center; padding: 2rem; border-radius: 1rem; color: white; cursor: default;">
  <i class="fas fa-user-circle" style="font-size: 4rem; margin-bottom: 1rem;"></i>
  <h3 style="margin: 0; font-weight: 600; font-size: 1.25rem;">Developer Info</h3>
  <h2 style="margin: 0.5rem 0 0 0; font-size: 1.5rem; font-weight: 700;">Vikash Jha</h2>
  <p style="font-size: 1rem; margin-top: 0.5rem;">
    <a href="mailto:vikashjha9137@gmail.com" style="color: #bfdbfe; text-decoration: none;">vikashjha9137@gmail.com</a>
  </p>
</div>
      </div>
    </div>
  </div>

  <!-- Add your Donations, Expenses, Members, Gallery pages here, as before -->
  <!-- ... -->
  <div id="donations" class="page">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-donate" style="color: #10b981; font-size: 1.5rem;"></i>
                    <h2>Donation Management</h2>
                </div>
                <div class="form-grid" id="add-donation">
                    <input type="text" class="form-input" id="roomNumber" placeholder="Room Number">
                    <input type="text" class="form-input" id="donorName" placeholder="Donor Name">
                    <select class="form-input" id="paymentMode">
                        <option value="cash">Cash</option>
                        <option value="online">Online</option>
                    </select>
                    <input type="number" class="form-input" id="donationAmount" placeholder="Amount (₹)">
                    <button class="btn btn-primary" onclick="addDonation()">
                        <i class="fas fa-plus"></i>
                        Add Donation
                    </button>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Room No.</th>
                                <th>Name</th>
                                <th>Payment Mode</th>
                                <th>Amount (₹)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="donationsTable"></tbody>
                    </table>
                </div>
                <div class="total-display" id="totalDonations">
                    <h3>Total Donations Received</h3>
                    <div class="amount">₹0</div>
                </div>
            </div>
        </div>
        <!-- Expenses Page -->
        <div id="expenses" class="page">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-receipt" style="color: #3b82f6; font-size: 1.5rem;"></i>
                    <h2>Expense Management</h2>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;" id="add-expense">
                    <div class="form-group">
                        <input type="text" class="form-input" id="expenseName" placeholder="Expense Name">
                        <input type="number" class="form-input" id="expenseAmount" placeholder="Amount (₹)">
                    </div>
                    <div class="form-group">
                        <div class="file-upload" onclick="document.getElementById('expenseFile').click()">
                            <input type="file" id="expenseFile" accept="image/*,application/pdf,.doc,.docx" onchange="handleExpenseFile(this)">
                            <i class="fas fa-upload" style="font-size: 2rem; color: #6b7280; margin-bottom: 0.5rem;"></i>
                            <p id="expenseFileName">Click to upload attachment</p>
                        </div>
                        <button class="btn btn-secondary" onclick="addExpense()">
                            <i class="fas fa-plus"></i>
                            Add Expense
                        </button>
                    </div>
                </div>
                <div id="expensesList"></div>
                <div class="total-display" id="totalExpenses" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    <h3>Total Expenses</h3>
                    <div class="amount">₹0</div>
                </div>
            </div>
        </div>
        <!-- Members Page -->
        <div id="members" class="page">
            <div class="card">
                <div class="card-header" >
                    <i class="fas fa-users" style="color: #8b5cf6; font-size: 1.5rem;"></i>
                    <h2>Members Management</h2>
                </div>
                <div class="form-grid" style="grid-template-columns: 1fr 1fr;" id="add-member">
                    <div class="form-group">
                        <input type="text" class="form-input" id="memberName" placeholder="Member Name">
                      
                        <input type="text" class="form-input" id="memberContact" placeholder="Contact Number">
                    </div>
                    <div class="form-group">
                        <div class="file-upload" onclick="document.getElementById('memberPhoto').click()">
                            <input type="file" id="memberPhoto" accept="image/*" onchange="handleMemberPhoto(this)">
                            <div id="photoPreview">
                                <i class="fas fa-camera" style="font-size: 2rem; color: #6b7280; margin-bottom: 0.5rem;"></i>
                                <p id="photoFileName" >Click to upload photo</p>
                            </div>
                        </div>
                        <button class="btn btn-accent" onclick="addMember()">
                            <i class="fas fa-plus"></i>
                            Add Member
                        </button>
                    </div>
                </div>
                <div class="member-grid" id="membersGrid"></div>
                <div id="membersEmpty" class="empty-state">
                    <i class="fas fa-users"></i>
                    <p>No members added yet</p>
                </div>
            </div>
        </div>
      <div id="gallery" class="page">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-images" style="color: #ea580c; font-size: 1.5rem;"></i>
                    <h2>Image Gallery</h2>
                </div>
                <div class="file-upload btn-upload-image" style="margin-bottom: 2rem;" onclick="document.getElementById('galleryImages').click()">
                    <input type="file" id="galleryImages" accept="image/*" multiple onchange="handleGalleryImages(this)">
                    <i class="fas fa-camera" style="font-size: 3rem; color: #6b7280; margin-bottom: 1rem;"></i>
                    <h3 style="margin-bottom: 0.5rem; color: #374151;">Upload Festival Photos</h3>
                    <p style="color: #6b7280;">Click to select multiple images</p>
                </div>
                <div class="image-grid" id="imageGrid"></div>
                <div id="galleryEmpty" class="empty-state">
                    <i class="fas fa-images"></i>
                    <p>No images uploaded yet</p>
                </div>
            </div>
        </div>
</div>
<!-- Modal -->
<div class="modal" id="imageModal">
  <div class="modal-content">
    <img id="modalImage" src="" alt="">
    <button class="modal-close" onclick="closeModal()">✕</button>
    <div class="modal-info" id="modalInfo">
      <p id="modalImageName"></p>
      <p id="modalImageDate"></p>
    </div>
  </div>
</div>
<script>
/* Place all your Firebase JS functions as before (addDonation, loadDonations, etc.) */
/* Navigation verification with error-handling and alerts */
document.addEventListener('DOMContentLoaded', function() {
  // Each tab and card click gets an alert and shows the proper page
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const pageId = this.getAttribute('data-page');
      
      if (!pageId) {
        alert('Error: Navigation button has no linked page.');
        return;
      }
      let pageEl = document.getElementById(pageId);
      if (!pageEl) {
        alert('Error: Page "' + pageId + '" not found in HTML!');
        return;
      }
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      pageEl.classList.add('active');
      document.querySelectorAll('.nav-btn').forEach(btn2 => btn2.classList.remove('active'));
      this.classList.add('active');
      document.getElementById('navigation').style.display = (pageId !== 'home') ? 'block' : 'none';
    });
  });
  document.querySelectorAll('.page-card').forEach(card => {
    card.addEventListener('click', function() {
      const pageId = this.getAttribute('data-page');
      
      if (!pageId) {
        alert('Error: Card has no linked page.');
        return;
      }
      let pageEl = document.getElementById(pageId);
      if (!pageEl) {
        alert('Error: Page "' + pageId + '" not found in HTML!');
        return;
      }
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      pageEl.classList.add('active');
      document.querySelectorAll('.nav-btn').forEach(btn2 => btn2.classList.remove('active'));
      let navBtn = document.querySelector(`.nav-btn[data-page="${pageId}"]`);
      if(navBtn) navBtn.classList.add('active');
      document.getElementById('navigation').style.display = (pageId !== 'home') ? 'block' : 'none';
    });
  });
  fetchVisibilityFlag();
  loadDonations();
    loadExpenses();
    loadMembers();
    loadGallery();
});
  function formatFileSize(size) {
    if (size < 1024) return size + " B";
    else if (size < 1024 * 1024) return (size / 1024).toFixed(1) + " KB";
    else return (size / (1024 * 1024)).toFixed(1) + " MB";
  }
/* The rest of your CRUD/DB code here */ // Donation Functions
   function fetchVisibilityFlag() {
  const docId = "HideShow"; // replace with your actual doc id
  db.collection("HideShowFlag").doc(docId).get()
    .then(doc => {
      if(doc.exists) {
        
        
        const flag = doc.data().Flag;
        
               applyVisibility(flag);
      } else {
       
        applyVisibility(true); // default to visible if not found
      }
    })
    .catch(error => {
      console.error("Error fetching flag:", error);
      applyVisibility(true);
    });
}
  function applyVisibility(flag) {
  const displayStyle = flag ? 'inline-block' : 'none';
   

  // Donations
  document.querySelectorAll('#add-donation').forEach(el => el.style.display = displayStyle);
  document.querySelectorAll('.btn-delete-donation').forEach(el => el.style.display = displayStyle);

  // Members
  document.querySelectorAll('#add-member').forEach(el => el.style.display = displayStyle);
  document.querySelectorAll('.btn-delete-member').forEach(el => el.style.display = displayStyle);

  // Expenses
  document.querySelectorAll('#add-expense').forEach(el => el.style.display = displayStyle);
  document.querySelectorAll('.btn-delete-expense').forEach(el => el.style.display = displayStyle);

  // Upload Images
  document.querySelectorAll('.btn-upload-image').forEach(el => el.style.display = displayStyle);
}

     
  function addDonation() {
    
    const roomNumber = document.getElementById('roomNumber').value;
    const name = document.getElementById('donorName').value;
    const paymentMode = document.getElementById('paymentMode').value;
    const amount = parseFloat(document.getElementById('donationAmount').value);
    if (roomNumber && name && amount) {
      
      db.collection("donations").add({
        roomNumber, name, paymentMode, amount, date: new Date().toLocaleDateString()
      }).then(() => {
        
        clearDonationForm(); loadDonations();
      });
      } 
    else alert('Please fill all fields for donation.');
  }  
  function loadDonations() {
    db.collection("donations").get().then(q => {
      donations = [];
      q.forEach(doc => { let d = doc.data(); d.id = doc.id; donations.push(d); });
      renderDonations();
    });
  }
  function deleteDonation(id) {
    db.collection("donations").doc(id).delete().then(loadDonations);
  }
  function renderDonations() {
    const tableBody = document.getElementById('donationsTable');
    const totalAmount = donations.reduce((sum, d) => sum + d.amount, 0);
    tableBody.innerHTML = donations.map(donation => `
      <tr>
        <td>${donation.roomNumber}</td>
        <td>${donation.name}</td>
        <td><span class="badge ${donation.paymentMode === 'cash' ? 'badge-success' : 'badge-info'}">${donation.paymentMode.toUpperCase()}</span></td>
        <td><strong>₹${donation.amount.toLocaleString()}</strong></td>
        <td><button class="btn btn-danger btn-delete-donation" style="padding:0.25rem 0.5rem;" onclick="deleteDonation('${donation.id}')"><i class="fas fa-trash"></i></button></td>
      </tr>
    `).join('');
    document.querySelector('#totalDonations .amount').textContent = `₹${totalAmount.toLocaleString()}`;
  }
  function clearDonationForm() {
    document.getElementById('roomNumber').value = '';
    document.getElementById('donorName').value = '';
    document.getElementById('paymentMode').value = 'cash';
    document.getElementById('donationAmount').value = '';
  }

        // Expense Functions
   // Declare db globally (already done): const db = firebase.firestore();

// Expense upload code (attachment as base64 for Firestore safety)


let expenseAttachmentFile = null;

function handleExpenseFile(input) {
  expenseAttachmentFile = input.files[0];
  document.getElementById('expenseFileName').textContent = expenseAttachmentFile ?
    `${expenseAttachmentFile.name} (${formatFileSize(expenseAttachmentFile.size)})` : "संलग्नक: कोई नहीं";
}

function addExpense() {
  const name = document.getElementById('expenseName').value.trim();
  const amount = parseFloat(document.getElementById('expenseAmount').value);

  if (!name || !amount) {
    alert('कृपया व्यय का नाम और राशि भरें।');
    return;
  }

  if (expenseAttachmentFile) {
    uploadToCloudinary(expenseAttachmentFile, (url, fname, fsize) => {
      if (url) saveExpense(name, amount, url, fname, fsize);
      else alert("Attachment upload failed!");
    });
  } else {
    saveExpense(name, amount, null, null, null);
  }
}

function saveExpense(name, amount, attachmentURL, attachmentName, attachmentSize) {
  db.collection('expenses').add({
    name,
    amount,
    date: new Date().toLocaleDateString(),
    attachmentURL: attachmentURL || null,
    attachmentName: attachmentName || null,
    attachmentSize: attachmentSize || null
  }).then(()=>{
    alert('व्यय सफलतापूर्वक जोड़ा गया!');
    clearExpenseForm();
    loadExpenses();
  }).catch(e=>alert('व्यय जोड़ने में त्रुटि: ' + e.message));
}

function clearExpenseForm() {
  document.getElementById('expenseName').value = '';
  document.getElementById('expenseAmount').value = '';
  document.getElementById('expenseFileName').textContent = 'Click to upload attachment';
  document.getElementById('expenseFile').value = '';
  expenseAttachmentFile = null;
}

// Load all expenses from Firestore
function loadExpenses() {
  db.collection("expenses").get()
    .then(querySnapshot => {
      const expenses = [];
      querySnapshot.forEach(doc => {
        let data = doc.data();
        data.id = doc.id;
        expenses.push(data);
      });
    alert("inside loading expenses");
      renderExpenses(expenses);
    })
    .catch(error => {
      alert("Error loading expenses: " + error.message);
      console.error("Error loading expenses:", error);
    });
}
   function formatFileSize(size) {
  if(size < 1024) return size + " B";
  else if(size < 1024 * 1024) return (size / 1024).toFixed(1) + " KB";
  else return (size / (1024 * 1024)).toFixed(1) + " MB";
}

function renderExpenses(expenses) {
  const container = document.getElementById('expensesList');
  const total = expenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);

  container.innerHTML = expenses.map(expense => `
    <div style="
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 1rem 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      font-family: Arial, sans-serif;
      background: #fff;
    ">
      <div style="flex-grow: 1; min-width: 180px;">
        <h3 style="margin: 0 0 0.25rem 0; color: #dc2626;">${expense.name || 'Unknown Expense'}</h3>
        <div style="font-size: 0.9rem; color: #6b7280;">
          Date: ${expense.date || 'N/A'}
        </div>
        ${expense.attachmentURL ? `
          <div style="margin-top: 0.25rem;">
            Attachment: ${expense.attachmentName || 'Attachment'} (${formatFileSize(expense.attachmentSize || 0)})
            <button 
              onclick="window.open('${expense.attachmentURL}', '_blank')" 
              style="background: #3b82f6; color: white; border: none; border-radius: 5px; padding: 0.2rem 0.6rem; font-size: 0.8rem; cursor: pointer; margin-left: 0.5rem;">
              View
            </button>
          </div>
        ` : ''}
      </div>
      <div style="min-width: 80px; font-weight: 700; color: #059669; font-size: 1.2rem; text-align: right;">
        ₹${(expense.amount || 0).toLocaleString()}
      </div>
      <button 
        onclick="deleteExpense('${expense.id}')" 
        style="background: #ef4444; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 8px; cursor: pointer; flex-shrink: 0;">
        Delete
      </button>
    </div>
  `).join('');

  document.getElementById('totalExpenses').textContent = `कुल व्यय: ₹${total.toLocaleString()}`;
}


    function deleteExpense(id) {
      if(confirm("क्या आप इस व्यय को हटाना चाहते हैं?")) {
        db.collection('expenses').doc(id).delete()
          .then(() => {
            alert("व्यय सफलतापूर्वक हटाया गया!");
            loadExpenses();
          })
          .catch(err => alert("Error deleting expense: " + err.message));
      }
    }

    window.onload = () => {
      loadExpenses();
    };  
let galleryImages = [];

// Universal Cloudinary upload function (updated to work with both patterns)

// Handle gallery image uploads
async function handleGalleryImages(input) {
  const files = Array.from(input.files);
  
  if (files.length === 0) {
    alert('कोई फाइल चयनित नहीं है।');
    return;
  }

  // Validate file types
  const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
  const invalidFiles = files.filter(file => !validTypes.includes(file.type));
  
  if (invalidFiles.length > 0) {
    alert('कृपया केवल image फाइलें चुनें (JPG, PNG, GIF, WebP)');
    return;
  }

  let successCount = 0;
  let errors = [];
  const totalFiles = files.length;

  // Show progress
  alert(`${totalFiles} फाइलें अपलोड हो रही हैं... कृपया प्रतीक्षा करें।`);

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    try {
      console.log(`Uploading ${i + 1}/${totalFiles}: ${file.name}`);
      
      // Upload to Cloudinary
      //const uploadResult = await uploadToCloudinary(file);
    uploadToCloudinary(file, (url, fname, fsize) => {
    if (url) {
       try {
        // Save to Firestore after successful upload
        await db.collection("gallery").add({
          url: url,                    // Cloudinary URL
          name: filename || file.name, // Use Cloudinary filename or fallback to original
          type: file.type,
          size: size || file.size,     // Use Cloudinary size or fallback to original
          date: new Date().toLocaleDateString('hi-IN'),
          uploadDate: new Date(),
          publicId: publicId || null
        });
        
        console.log('Upload and save successful');
        alert('फ़ाइल सफलतापूर्वक अपलोड हुई!');
        
      } catch (dbError) {
        console.error('Database save failed:', dbError);
        alert("डेटाबेस में सेव करने में त्रुटि!");
      }
    } else {
      console.error('Upload failed');
      alert("फ़ाइल अपलोड में त्रुटि!");
    }
    }
          });
    
      successCount++;
      console.log(`Successfully uploaded: ${file.name}`);
      
    } catch (err) {
      console.error(`Failed to upload ${file.name}:`, err);
      errors.push(`${file.name}: ${err.message}`);
    }
  }

  // Show results
  if (successCount > 0 && errors.length === 0) {
    alert(`सभी ${successCount} फोटो सफलतापूर्वक अपलोड हुईं!`);
  } else if (successCount > 0) {
    alert(`${successCount}/${totalFiles} फोटो अपलोड हुईं।\n\nअसफल:\n${errors.join('\n')}`);
  } else {
    alert(`कोई भी फोटो अपलोड नहीं हुई:\n${errors.join('\n')}`);
  }

  // Reset file input and reload gallery
  input.value = "";
  loadGallery();
}

// Load images from Firestore
async function loadGallery() {
  try {
    console.log('Loading gallery images...');
    const snapshot = await db.collection('gallery')
                            .orderBy('uploadDate', 'desc')
                            .get();
    
    galleryImages = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      galleryImages.push({ 
        id: doc.id, 
        ...data 
      });
    });
    
    console.log(`Loaded ${galleryImages.length} images`);
    renderGallery(galleryImages);
    
  } catch (error) {
    console.error("Error loading gallery:", error);
    
    // Try alternative query if orderBy fails
    try {
      const snapshot = await db.collection('gallery').get();
      galleryImages = [];
      snapshot.forEach(doc => {
        galleryImages.push({ id: doc.id, ...doc.data() });
      });
      
      // Sort manually if orderBy failed
      galleryImages.sort((a, b) => {
        const dateA = a.uploadDate ? new Date(a.uploadDate.toDate()) : new Date();
        const dateB = b.uploadDate ? new Date(b.uploadDate.toDate()) : new Date();
        return dateB - dateA;
      });
      
      renderGallery(galleryImages);
    } catch (fallbackError) {
      console.error("Fallback load also failed:", fallbackError);
      alert("गैलरी लोड करने में त्रुटि: " + fallbackError.message);
      renderGallery([]);
    }
  }
}

// Render gallery images
function renderGallery(images) {
  const container = document.getElementById('imageGrid');
  const emptyMsg = document.getElementById('galleryEmpty');
  
  if (!container) {
    console.error('imageGrid element not found');
    return;
  }
  
  if (!images || images.length === 0) {
    container.innerHTML = "";
    if (emptyMsg) emptyMsg.style.display = "block";
    return;
  }
  
  if (emptyMsg) emptyMsg.style.display = "none";
  
  container.innerHTML = images.map(img => `
    <div class="image-item">
      <button class="delete-btn" onclick="deleteImage('${img.id}')" title="फोटो हटाएं">
        <i class="fas fa-times"></i>
      </button>
      <img 
        src="${img.url}" 
        alt="${img.name || 'Gallery Image'}" 
        onclick="showModal('${imgUrl}', '${imgName}', '${imgDate}')" 
        onerror="this.style.display='none'"
        loading="lazy"
      />
    </div>
  `).join('');
  
  console.log(`Rendered ${images.length} images`);
}

// Delete image from Firestore
function deleteImage(id) {
  if (!confirm("क्या आप वाकई इस फोटो को हटाना चाहते हैं?")) {
    return;
  }
  
  db.collection('gallery').doc(id).delete()
    .then(() => {
      alert('तस्वीर सफलतापूर्वक हटाई गई।');
      loadGallery();
    })
    .catch(error => {
      console.error('Error deleting image:', error);
      alert('तस्वीर हटाने में त्रुटि: ' + error.message);
    });
}

// Modal functions
function showModal(url, name, date) {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  const modalImageName = document.getElementById('modalImageName');
  const modalImageDate = document.getElementById('modalImageDate');
  
  if (!modal || !modalImage) {
    console.error('Modal elements not found');
    return;
  }
  
  modalImage.src = url;
  
  if (modalImageName) modalImageName.textContent = name;
  if (modalImageDate) modalImageDate.textContent = date;
  
  modal.classList.add('active');
  
  // Prevent body scroll when modal is open
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  const modal = document.getElementById('imageModal');
  const modalImage = document.getElementById('modalImage');
  
  if (!modal || !modalImage) {
    console.error('Modal elements not found');
    return;
  }
  
  modal.classList.remove('active');
  modalImage.src = '';
  
  // Restore body scroll
  document.body.style.overflow = 'auto';
}

// Event listeners for modal (add this to your DOMContentLoaded event)
function initializeGalleryEvents() {
  // Close modal when clicking outside
  const modal = document.getElementById('imageModal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeModal();
      }
    });
  }
  
  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
      closeModal();
    }
  });
  
  // Close button
  const closeBtn = document.querySelector('.modal-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', closeModal);
  }
}

// File size formatter
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Initialize gallery when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Initialize gallery events
  initializeGalleryEvents();
  
  // Load gallery images
  loadGallery();
});

// Alternative initialization if DOMContentLoaded already fired
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    initializeGalleryEvents();
    loadGallery();
  });
} else {
  initializeGalleryEvents();
  loadGallery();
}
// Fixed Member Management Functions - Replace your existing member code with this


// Add member function similar to addExpense/addDonation


// Your other functions...
function handleMemberPhoto(input) {
    alert("inside handle");
    memberPhotoFile = input.files[0] || null;
    if(memberPhotoFile) 
        alert('Selected photo: ' + memberPhotoFile.name);
    else 
        alert('No photo selected');
}

function addMember() {
  
  const name = document.getElementById('memberName').value.trim();
    const contact = document.getElementById('memberContact').value.trim();
    
    if (!name) {
        alert('कृपया सदस्य का नाम भरें।');
        return;
    }

    if (memberPhotoFile) {
        // Use Cloudinary upload function (same as expenses)
        uploadToCloudinary(memberPhotoFile, (url, fname, fsize) => {
            if (url) {
                saveMember(name, contact, url, fname);
            } else {
                alert("फ़ोटो अपलोड में त्रुटि!");
            }
        });
    } else {
        saveMember(name, contact, null, null);
    }
}

// Save member document in Firestore
function saveMember(name, contact, photoURL, photoName) {
  ("inside save member");
  const memberData = {
    name: name,
    contact: contact || '',
    date: new Date().toLocaleDateString(),
    timestamp: new Date()
  };

  if (photoURL) {
    memberData.photoURL = photoURL;
    memberData.photoName = photoName;
  }

  db.collection('members').add(memberData)
    .then(() => {
      alert('सदस्य सफलतापूर्वक जोड़ा गया!');
      clearMemberForm();
      loadMembers();
    })
    .catch(error => {
      alert('सदस्य जोड़ने में त्रुटि: ' + error.message);
    });
}

// Clear member form and photo preview
function clearMemberForm() {
  document.getElementById('memberName').value = '';
  document.getElementById('memberContact').value = '';
  document.getElementById('memberPhoto').value = '';
  memberPhotoFile = null;

  document.getElementById('photoPreview').innerHTML = `
    <i class="fas fa-camera" style="font-size: 2rem; color: #6b7280; margin-bottom: 0.5rem;"></i>
    <p id="photoFileName">Click to upload photo</p>
  `;
}

// Load members and render - you should have this existing or similar
function loadMembers() {
  db.collection("members").orderBy("timestamp", "desc").get()
    .then((querySnapshot) => {
      const members = [];
      querySnapshot.forEach((doc) => {
        let data = doc.data();
        data.id = doc.id;
        members.push(data);
      });
      renderMembers(members);
    })
    .catch((error) => {
      alert("Error loading members: " + error.message);
    });
}
// Render members grid
function renderMembers(members) {
  const membersGrid = document.getElementById('membersGrid');
  const membersEmpty = document.getElementById('membersEmpty');
  
  if (!members.length) {
    membersGrid.innerHTML = '';
    membersEmpty.style.display = 'block';
    return;
  }

  membersGrid.innerHTML = members.map(member => `
    <div class="member-card">
      <button class="delete-btn btn-delete-member" onclick="deleteMember('${member.id}')">
        <i class="fas fa-times"></i>
      </button>
      
      ${member.photoURL ? 
        `<img src="${member.photoURL}" alt="${member.name}" class="member-photo" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
         <div class="member-placeholder" style="display: none;">
           <i class="fas fa-user"></i>
         </div>` : 
        `<div class="member-placeholder">
           <i class="fas fa-user"></i>
         </div>`
      }
      
      <h3 style="font-size: 1.125rem; font-weight: 600; margin: 0 0 0.5rem 0; color: #1f2937;">${member.name}</h3>
      
      ${member.contact ? 
        `<p style="color: #6b7280; font-size: 0.875rem; margin: 0 0 0.5rem 0;">
           <i class="fas fa-phone" style="margin-right: 0.25rem;"></i>${member.contact}
         </p>` : ''
      }
      
      <p style="color: #9ca3af; font-size: 0.75rem; margin: 0;">
        Added: ${member.date}
      </p>
    </div>
  `).join('');
  
  membersEmpty.style.display = 'none';
}

// Delete member from Firestore and Storage
function deleteMember(id) {
  if (confirm('Are you sure you want to delete this member?')) {
    // First get member data to check if there's a photo to delete from storage
    db.collection("members").doc(id).get()
      .then((doc) => {
        if (doc.exists) {
          const memberData = doc.data();
          
          // Delete from Firestore first
          return db.collection("members").doc(id).delete().then(() => {
            // If member has a photo, delete it from storage
            if (memberData.photoURL) {
              const photoRef = firebase.storage().refFromURL(memberData.photoURL);
              return photoRef.delete().catch((error) => {
                console.warn('Could not delete member photo from storage:', error);
                // Don't fail the whole operation if photo deletion fails
              });
            }
          });
        }
      })
      .then(() => {
        alert('Member deleted successfully!');
        loadMembers();
      })
      .catch((error) => {
        console.error('Error deleting member:', error);
        alert('Error deleting member: ' + error.message);
      });
  }
}

// Helper function to get member by ID (if needed)
function getMember(id) {
  return db.collection("members").doc(id).get()
    .then((doc) => {
      if (doc.exists) {
        const data = doc.data();
        data.id = doc.id;
        return data;
      } else {
        throw new Error("Member not found");
      }
    });
}
</script>
<script>
 const firebaseConfig = {
  apiKey: "AIzaSyDHCFp2U83R2htaKKz5ZTRAPLahh7lkcXE",
  authDomain: "ganpati2025-da162.firebaseapp.com",
  databaseURL: "https://ganpati2025-da162-default-rtdb.firebaseio.com",
  projectId: "ganpati2025-da162",
  storageBucket: "ganpati2025-da162.firebasestorage.appspot.com",
  messagingSenderId: "198731408007",
  appId: "1:198731408007:web:a61f4bf5b6fbcb83ae8e22",
  measurementId: "G-043GNXQ86Q"
};

   
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

  const storage = firebase.storage();
   let memberPhotoFile = null;

   
  
 
  </script>
  <script>
const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dosohpffj/upload"; // Replace <cloud_name>
const CLOUDINARY_UPLOAD_PRESET = "Ganpati2025"; // Replace <upload_preset>

// Universal Cloudinary upload function
function uploadToCloudinary(file, callback) {
  alert('inside upload cloudanary');
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

  fetch(CLOUDINARY_URL, {
    method: 'POST',
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    if(data.secure_url) callback(data.secure_url, data.original_filename, data.bytes);
    else callback(null, null, null);
  })
  .catch(() => callback(null, null, null));
}
</script>


</body>
</html>
